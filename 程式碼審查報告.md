# 程式碼審查報告：Documents Translate Console

## 發現的問題

### 1. 安全性問題

| 問題 | 位置 | 嚴重程度 |

|------|------|----------|

| API Key 儲存在 localStorage | 前端 | 高 |
| CORS 配置過於寬鬆 | `backend/main.py:39-44` | 中 |
| 缺少速率限制 | 全體 API | 中 |
| 檔案上傳無大小限制 | `backend/main.py:102, 116` | 中 |
| 缺少 SQL 注入防護 | `backend/services/translation_memory.py` | 低 |

### 2. 程式碼品質問題

| 問題 | 位置 | 嚴重程度 |

|------|------|----------|

| 前端檔案過長 | `frontend/src/App.jsx` (1459行) | 高 |
| 缺少 TypeScript | 全體前端 | 中 |
| 缺少 ESLint 配置 | `frontend/` | 中 |
| 缺少測試覆蓋 | `tests/` | 中 |
| 錯誤處理不完整 | 多個 API 端點 | 中 |
| 硬編碼配置 | `frontend/src/App.jsx:3` | 低 |

### 3. 效能問題

| 問題 | 位置 | 嚴重程度 |

|------|------|----------|

| 過多 React re-renders | `frontend/src/App.jsx` | 中 |
| 缺少 API 響應快取 | `backend/main.py` | 中 |
| 同步處理大檔案 | `backend/main.py:124-131` | 中 |
| 資料庫連接未優化 | `backend/services/translation_memory.py` | 低 |

### 4. 架構問題

| 問題 | 位置 | 嚴重程度 |

|------|------|----------|

| 服務層職責不清 | `backend/services/` | 中 |
| 缺少中介層 | 全體 | 中 |
| 配置管理分散 | 多個檔案 | 低 |
| 缺少 API 文件 | - | 低 |

---

## 改善方案

### 第一階段：安全性加固 (優先)

1. **API Key 安全儲存**
   - 使用後端代理 API 請求
   - 實施 HttpOnly cookies
   - 移除 localStorage 敏感資料

2. **CORS 與速率限制**
   - 配置更嚴格的 CORS 策略
   - 添加 SlowAPI 速率限制
   - 實施檔案大小限制

3. **輸入驗證**
   - 使用 Pydantic V2 驗證模型
   - 添加檔案類型檢查
   - 實施 SQL 參數化查詢

### 第二階段：程式碼重構

1. **前端重構**

   ```
   - 拆分 App.jsx 為多個元件
   - 添加 React Query 狀態管理
   - 建立自定義 Hooks
   - 實作代碼分割
   ```

2. **後端重構**

   ```
   - 拆分 main.py 為多個路由檔案
   - 建立統一的錯誤處理
   - 添加中介層
   - 實作依賴注入
   ```

### 第三階段：測試與品質

1. **添加測試覆蓋**
   - 前端：React Testing Library
   - 後端：pytest + coverage
   - E2E 測試：Playwright

2. **代碼品質工具**

   ```
   - 前端：ESLint + Prettier + Husky
   - 後端：Ruff + mypy + pre-commit
   ```

### 第四階段：效能優化

1. **前端優化**
   - React.memo 避免不必要的 re-renders
   - 使用 Suspense 和 lazy loading
   - 實作虛擬滾動

2. **後端優化**
   - 添加 Redis 快取
   - 實施資料庫連接池
   - 優化翻譯批次處理

---

## 執行計劃

### 階段一：安全性修復 (1-2 週)

| 任務 | 負責 | 預估時間 |

|------|------|----------|

| 移除 localStorage API Key | 前端 | 2 天 |
| 配置 CORS 白名單 | 後端 | 1 天 |
| 添加速率限制 | 後端 | 3 天 |
| 檔案上傳大小限制 | 後端 | 1 天 |
| SQL 參數化查詢 | 後端 | 2 天 |

### 階段二：代碼重構 (2-4 週)

| 任務 | 負責 | 預估時間 |

|------|------|----------|

| 拆分前端元件 | 前端 | 1 週 |
| 建立 Hooks 抽象 | 前端 | 3 天 |
| 拆分後端路由 | 後端 | 1 週 |
| 統一錯誤處理 | 後端 | 3 天 |
| 實作依賴注入 | 後端 | 1 週 |

### 階段三：測試與 CI/CD (1-2 週)

| 任務 | 負責 | 預估時間 |

|------|------|----------|

| 添加後端單元測試 | 測試 | 5 天 |
| 添加前端單元測試 | 測試 | 5 天 |
| 配置 GitHub Actions | DevOps | 2 天 |
| 添加 E2E 測試 | 測試 | 3 天 |

### 階段四：效能優化 (1-2 週)

| 任務 | 負責 | 預估時間 |

|------|------|----------|

| React 效能優化 | 前端 | 3 天 |
| 添加 Redis 快取 | 後端 | 5 天 |
| 資料庫優化 | 後端 | 3 天 |
| API 響應優化 | 後端 | 2 天 |

---

## 立即可執行的項目

### 1. 創建 `.env.example`

```bash
# 環境變數範本
OPENAI_API_KEY=
GEMINI_API_KEY=
TRANSLATE_LLM_MODE=mock
LLM_MAX_RETRIES=2
UPLOAD_MAX_SIZE=10485760
RATE_LIMIT_PER_MINUTE=60
```

### 2. 添加 `.eslintrc.cjs`

```javascript
module.exports = {
  root: true,
  env: { browser: true, es2020: true },
  extends: [
    'eslint:recommended',
    'plugin:react/recommended',
    'plugin:react/jsx-runtime'
  ],
  rules: {
    'react/react-in-jsx-scope': 'off',
    'react/prop-types': 'off'
  }
}
```

### 3. 添加 `.pre-commit-config.yaml`

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files

  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
```

### 4. 創建 `pytest.ini`

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --cov=backend --cov-report=html
```

### 5. 添加 `.gitignore`

```
# 環境檔案
.env
.env.local

# 測試覆蓋
.coverage
htmlcov/

# 快取
__pycache__/
*.pyc
.pytest_cache/
node_modules/

# 構建產出
dist/
build/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
```

---

## 風險評估

| 風險 | 可能性 | 影響 | 緩解措施 |

|------|--------|------|----------|

| 重構導致功能回歸 | 中 | 高 | 逐步重構、充分測試 |
| 安全性修復影響用戶體驗 | 低 | 中 | 提供遷移指南 |
| 效能優化未達預期 | 中 | 中 | 持續監控與迭代 |

---

此報告涵蓋了主要問題與改善方案，建議按照執行計劃的優先順序逐步實施。如需開始特定階段，請告知優先順序。
